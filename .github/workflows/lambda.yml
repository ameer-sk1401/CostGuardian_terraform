name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - "lambda/**/*.py"
      - "lambda/**/requirements.txt"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: us-west-1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Package Main Lambda
        run: |
          echo "ğŸ“¦ Building Main Lambda package..."
          cd lambda

          # Install dependencies if requirements.txt exists
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt -t package/
            cp lambda_handler.py package/
            cd package
            zip -r ../../lambda_function.zip . -q
            cd ../..
            rm -rf lambda/package
          else
            zip -r lambda_function.zip lambda_handler.py -q
          fi

          echo "âœ… Main Lambda package created: $(ls -lh lambda_function.zip | awk '{print $5}')"

      - name: Package Cost Savings Lambda
        run: |
          echo "ğŸ“¦ Building Cost Savings Lambda package..."
          cd lambda
          zip -r ../cost_savings_function.zip cost_savings_calculator.py pricing.py -q
          cd ..
          echo "âœ… Cost Savings Lambda package created: $(ls -lh cost_savings_function.zip | awk '{print $5}')"

      - name: Update Main Lambda Function
        run: |
          echo "ğŸš€ Deploying Main Lambda..."
          aws lambda update-function-code \
            --function-name costguardian-prod-main \
            --zip-file fileb://lambda_function.zip \
            --output json | jq -r '.LastModified'

          echo "âœ… Main Lambda updated successfully"

      - name: Update Cost Savings Lambda Function
        run: |
          echo "ğŸš€ Deploying Cost Savings Lambda..."
          aws lambda update-function-code \
            --function-name costguardian-prod-cost-savings \
            --zip-file fileb://cost_savings_function.zip \
            --output json | jq -r '.LastModified'

          echo "âœ… Cost Savings Lambda updated successfully"

      - name: Wait for Lambda updates to complete
        run: |
          echo "â³ Waiting for Lambda functions to be ready..."
          aws lambda wait function-updated --function-name costguardian-prod-main
          aws lambda wait function-updated --function-name costguardian-prod-cost-savings
          echo "âœ… All Lambda functions are ready!"

      - name: Test Main Lambda
        run: |
          echo "ğŸ§ª Testing Main Lambda..."
          aws lambda invoke \
            --function-name costguardian-prod-main \
            --payload '{}' \
            --log-type Tail \
            response.json > /dev/null 2>&1

          echo "Response:"
          cat response.json
          echo ""

      - name: Test Cost Savings Lambda
        run: |
          echo "ğŸ§ª Testing Cost Savings Lambda..."
          aws lambda invoke \
            --function-name costguardian-prod-cost-savings \
            --payload '{}' \
            --log-type Tail \
            response2.json > /dev/null 2>&1

          echo "Response:"
          cat response2.json
          echo ""

      - name: View Recent Logs
        if: always()
        run: |
          echo "ğŸ“‹ Recent Main Lambda logs:"
          aws logs tail /aws/lambda/costguardian-prod-main --since 5m --format short || echo "No logs available"

          echo ""
          echo "ğŸ“‹ Recent Cost Savings Lambda logs:"
          aws logs tail /aws/lambda/costguardian-prod-cost-savings --since 5m --format short || echo "No logs available"

      - name: Summary
        if: success()
        run: |
          echo "âœ… Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Main Lambda: costguardian-prod-main"
          echo "âœ… Cost Savings Lambda: costguardian-prod-cost-savings"
          echo "âœ… Both functions updated successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
